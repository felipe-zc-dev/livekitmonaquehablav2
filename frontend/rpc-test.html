<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>üß™ RPC Test Fixed - callAgentRPC Correcto</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
            }
            .container {
                background: white;
                padding: 30px;
                border-radius: 16px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            }
            .test-section {
                margin-bottom: 30px;
                padding: 25px;
                border: 2px solid #e9ecef;
                border-radius: 12px;
                background: #f8f9fa;
            }
            .fix-highlight {
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                font-weight: 600;
            }
            button {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                margin: 5px;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s ease;
            }
            button:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }
            button:disabled {
                background: #6c757d;
                cursor: not-allowed;
            }
            .result {
                margin-top: 15px;
                padding: 20px;
                background: #ffffff;
                border-radius: 8px;
                font-family: "Monaco", "Menlo", monospace;
                white-space: pre-wrap;
                max-height: 300px;
                overflow-y: auto;
                border-left: 4px solid #dee2e6;
                font-size: 13px;
                line-height: 1.5;
            }
            .success {
                border-left-color: #28a745;
                background-color: #d4edda;
                color: #155724;
            }
            .error {
                border-left-color: #dc3545;
                background-color: #f8d7da;
                color: #721c24;
            }
            .info {
                border-left-color: #17a2b8;
                background-color: #d1ecf1;
                color: #0c5460;
            }
            .warning {
                border-left-color: #ffc107;
                background-color: #fff3cd;
                color: #856404;
            }
            .grid-2 {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            @media (max-width: 768px) {
                .grid-2 {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="fix-highlight">
                üîß FIXED: Cambiado callRPCMethod() ‚Üí callAgentRPC() seg√∫n
                LiveKit v2.13.6
            </div>

            <h1>üß™ RPC Test - M√©todo Correcto</h1>
            <p>
                Testing con
                <strong>callAgentRPC() - API oficial LiveKit</strong>
            </p>

            <div class="test-section">
                <h3>üìä Estado del Sistema</h3>
                <button onclick="setupTestMode()">üß™ Setup Test Mode</button>
                <button onclick="initializeTestSystem()">
                    üöÄ Initialize Test System
                </button>
                <button onclick="connectToAgent()">üîó Connect to Agent</button>
                <button onclick="disconnectAgent()">‚ùå Disconnect</button>
                <div id="systemStatus" class="result info">
                    Sistema de test se preparar√° aqu√≠...
                </div>
            </div>

            <div class="grid-2">
                <div class="test-section">
                    <h3>üì§ RPC Calls - SALIENTES (FIXED)</h3>
                    <button
                        onclick="testHeartbeat()"
                        id="heartbeatBtn"
                        disabled
                    >
                        üíì Heartbeat
                    </button>
                    <button
                        onclick="testAgentCommand()"
                        id="commandBtn"
                        disabled
                    >
                        ü§ñ Agent Command
                    </button>
                    <button onclick="testLLMFunction()" id="llmBtn" disabled>
                        üß† LLM Function
                    </button>
                    <button onclick="testCustomRPC()" id="customBtn" disabled>
                        ‚ö° Custom Call
                    </button>
                    <div id="outgoingResults" class="result">
                        Resultados con callAgentRPC() aparecer√°n aqu√≠...
                    </div>
                </div>

                <div class="test-section">
                    <h3>üì• RPC Registry - ENTRANTES</h3>
                    <button onclick="showRegisteredMethods()">
                        üìã Show Methods
                    </button>
                    <button onclick="simulateIncoming()">üé≠ How to Test</button>
                    <div id="incomingResults" class="result">
                        Logs aparecer√°n aqu√≠...
                    </div>
                </div>
            </div>

            <div class="test-section">
                <h3>üîß Debug Info</h3>
                <button onclick="showVoiceAgentState()">
                    üé§ Voice Agent State
                </button>
                <button onclick="showAppState()">üì± App State</button>
                <button onclick="showConfigInfo()">‚öôÔ∏è CONFIG Info</button>
                <button onclick="testSystemMethods()">
                    üîç Test System Methods
                </button>
                <div id="debugInfo" class="result">
                    Debug info aparecer√° aqu√≠...
                </div>
            </div>
        </div>

        <!-- LiveKit SDK -->
        <script src="https://unpkg.com/livekit-client@latest/dist/livekit-client.umd.js"></script>

        <script>
            // Variables globales
            let voiceAgent = null;
            let voiceApp = null;
            let isTestModeSetup = false;
            let isSystemInitialized = false;

            function logResult(elementId, message, type = "info") {
                const el = document.getElementById(elementId);
                if (!el) {
                    console.error(`Element ${elementId} not found`);
                    return;
                }

                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${message}\n`;

                el.className = `result ${type}`;
                el.textContent += logEntry;
                el.scrollTop = el.scrollHeight;
            }

            function updateButtons(connected) {
                const buttons = [
                    "heartbeatBtn",
                    "commandBtn",
                    "llmBtn",
                    "customBtn",
                ];
                buttons.forEach((id) => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = !connected;
                });
            }

            // Mock element creation (sin cambios)
            function createCompletelyMockElement() {
                const mockStyle = new Proxy(
                    {},
                    {
                        set: () => true,
                        get: () => "",
                    }
                );

                const mockClassList = {
                    add: () => {},
                    remove: () => {},
                    toggle: () => {},
                    contains: () => false,
                };

                const mockElement = {
                    innerHTML: "",
                    textContent: "",
                    value: "",
                    disabled: false,
                    title: "",
                    id: "mock-element",
                    className: "",
                    style: mockStyle,
                    classList: mockClassList,
                    addEventListener: () => {},
                    removeEventListener: () => {},
                    querySelector: (selector) => createCompletelyMockElement(),
                    querySelectorAll: () => [],
                    appendChild: () => {},
                    removeChild: () => {},
                    setAttribute: () => {},
                    getAttribute: () => "",
                    hasAttribute: () => false,
                    offsetWidth: 100,
                    offsetHeight: 30,
                    scrollHeight: 30,
                    scrollTop: 0,
                    focus: () => {},
                    blur: () => {},
                    click: () => {},
                    toString: () => "[MockElement]",
                };

                return mockElement;
            }

            // Setup funciones (sin cambios importantes)
            function setupTestMode() {
                try {
                    logResult(
                        "systemStatus",
                        "üß™ Configurando modo test completo...",
                        "info"
                    );

                    window.CONFIG = {
                        test: {
                            enabled: true,
                            headlessMode: true,
                            skipDOMValidation: true,
                            preventAutoInit: true,
                        },
                        livekit: {
                            wsUrl: "ws://localhost:7880",
                            tokenEndpoint: "http://localhost:8000/getToken",
                            roomOptions: {
                                adaptiveStream: true,
                                dynacast: true,
                                autoSubscribe: true,
                                logLevel: "warn",
                            },
                            features: {
                                enablePrepareConnection: true,
                                enableAdaptiveStream: true,
                                enableDynacast: true,
                            },
                        },
                        rpc: {
                            enabled: true,
                            timeout: 10000,
                            methods: [
                                "llm_function_call",
                                "agent_command",
                                "heartbeat",
                                "update_ui_state",
                                "show_notification",
                                "change_persona",
                            ],
                        },
                        debug: {
                            enabled: true,
                            logRpcCalls: true,
                            showUIEvents: false,
                            showAudioEvents: false,
                        },
                    };

                    window.Logger = {
                        debug: (msg, ...args) =>
                            console.log(`üîç ${msg}`, ...args),
                        error: (msg, ...args) =>
                            console.error(`‚ùå ${msg}`, ...args),
                        info: (msg, ...args) =>
                            console.info(`‚ÑπÔ∏è ${msg}`, ...args),
                        warning: (msg, ...args) =>
                            console.warn(`‚ö†Ô∏è ${msg}`, ...args),
                        audio: (msg, ...args) =>
                            console.log(`üîä ${msg}`, ...args),
                        voice: (msg, ...args) =>
                            console.log(`üé§ ${msg}`, ...args),
                        connection: (msg, ...args) =>
                            console.log(`üîó ${msg}`, ...args),
                        rpc: (msg, ...args) =>
                            console.log(`üîß RPC: ${msg}`, ...args),
                        ui: (msg, ...args) => console.log(`üé® ${msg}`, ...args),
                    };

                    window.OriginalUIManager = null;

                    isTestModeSetup = true;
                    logResult(
                        "systemStatus",
                        "‚úÖ Modo test configurado correctamente",
                        "success"
                    );
                    logResult(
                        "systemStatus",
                        "   callAgentRPC() ser√° usado en lugar de callRPCMethod()",
                        "info"
                    );
                } catch (error) {
                    logResult(
                        "systemStatus",
                        `‚ùå Error configurando test: ${error.message}`,
                        "error"
                    );
                }
            }

            async function loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement("script");
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = () =>
                        reject(new Error(`Failed to load ${src}`));
                    document.head.appendChild(script);
                });
            }

            async function loadYourScripts() {
                const scripts = [
                    "js/config.js",
                    "js/voice-agent-sdk.js",
                    "js/ui-manager.js",
                    "js/app.js",
                ];

                for (const src of scripts) {
                    try {
                        await loadScript(src);
                        logResult(
                            "systemStatus",
                            `‚úÖ ${src} cargado`,
                            "success"
                        );
                    } catch (error) {
                        logResult(
                            "systemStatus",
                            `‚ùå Error ${src}: ${error.message}`,
                            "error"
                        );
                        return false;
                    }
                }
                return true;
            }

            function patchUIManagerForTest() {
                if (typeof window.UIManager === "undefined") {
                    throw new Error("UIManager not loaded yet");
                }

                window.OriginalUIManager = window.UIManager;

                window.UIManager = function () {
                    logResult(
                        "systemStatus",
                        "üîß UIManager interceptado - versi√≥n test",
                        "info"
                    );

                    this.elements = {};
                    const elementNames = [
                        "chatContainer",
                        "textInput",
                        "sendBtn",
                        "callBtn",
                        "messageForm",
                        "typingIndicator",
                        "audioBtn",
                        "callOverlay",
                        "hangupBtn",
                        "muteBtn",
                        "callSubtitles",
                        "voiceActivity",
                        "voiceActivityLabel",
                        "status",
                        "statusText",
                    ];

                    elementNames.forEach((name) => {
                        this.elements[name] = createCompletelyMockElement();
                    });

                    this.state = {
                        isVoiceMode: false,
                        audioEnabled: false,
                        micActive: false,
                        messageCount: 0,
                        toastContainer: null,
                        userSpeaking: false,
                        botThinking: false,
                        showingTypingIndicator: false,
                        audioInteractionRequired: false,
                    };

                    // M√©todos mock esenciales
                    this.updateStatus = (status, type) => {
                        logResult(
                            "systemStatus",
                            `üé® Mock UI Status: ${status} (${type})`,
                            "info"
                        );
                    };

                    this.showToast = (message, type, duration) => {
                        logResult(
                            "systemStatus",
                            `üé® Mock Toast: ${message} (${type})`,
                            "info"
                        );
                    };

                    this.addMessage = (content, sender, isStreaming) => {
                        logResult(
                            "systemStatus",
                            `üé® Mock Message: ${sender}: ${content.substring(
                                0,
                                30
                            )}...`,
                            "info"
                        );
                    };

                    this.showTypingIndicator = (show) => {
                        logResult(
                            "systemStatus",
                            `üé® Mock Typing: ${show}`,
                            "info"
                        );
                    };

                    this.updateAudioState = (enabled, requiresInteraction) => {
                        logResult(
                            "systemStatus",
                            `üé® Mock Audio: enabled=${enabled}, interaction=${requiresInteraction}`,
                            "info"
                        );
                    };

                    // Event system mock
                    this._eventHandlers = new Map();
                    this.on = (event, handler) => {
                        if (!this._eventHandlers.has(event)) {
                            this._eventHandlers.set(event, []);
                        }
                        this._eventHandlers.get(event).push(handler);
                    };

                    this._emitUIEvent = (event, ...args) => {
                        const handlers = this._eventHandlers.get(event) || [];
                        handlers.forEach((handler) => {
                            try {
                                handler(...args);
                            } catch (error) {
                                console.error(
                                    `Error in UI event ${event}:`,
                                    error
                                );
                            }
                        });
                    };

                    this.getState = () => this.state;
                    this.showVoiceMode = () => {};
                    this.updateVoiceActivity = () => {};
                    this.clearMessages = () => {};
                    this._hideAudioInteractionPrompt = () => {};
                    this._showAudioInteractionPrompt = () => {};

                    logResult(
                        "systemStatus",
                        "‚úÖ UIManager mock creado con elementos completos",
                        "success"
                    );
                };

                Object.setPrototypeOf(
                    window.UIManager,
                    window.OriginalUIManager
                );
            }

            async function initializeTestSystem() {
                try {
                    if (!isTestModeSetup) {
                        logResult(
                            "systemStatus",
                            '‚ùå Ejecuta "Setup Test Mode" primero',
                            "error"
                        );
                        return;
                    }

                    logResult(
                        "systemStatus",
                        "üöÄ Inicializando sistema de test...",
                        "info"
                    );

                    const loaded = await loadYourScripts();
                    if (!loaded) return;

                    logResult(
                        "systemStatus",
                        "üîß Patching UIManager para test...",
                        "info"
                    );
                    patchUIManagerForTest();

                    if (typeof window.ModernVoiceAgent === "undefined") {
                        throw new Error("ModernVoiceAgent no disponible");
                    }

                    logResult(
                        "systemStatus",
                        "üèóÔ∏è Creando instancias...",
                        "info"
                    );

                    voiceAgent = new window.ModernVoiceAgent();
                    logResult(
                        "systemStatus",
                        "‚úÖ ModernVoiceAgent creado",
                        "success"
                    );

                    if (typeof window.VoiceAgentApp !== "undefined") {
                        voiceApp = new window.VoiceAgentApp();
                        await voiceApp.init();
                        logResult(
                            "systemStatus",
                            "‚úÖ VoiceAgentApp inicializado en modo test",
                            "success"
                        );
                    }

                    setupEventListeners();

                    isSystemInitialized = true;
                    logResult(
                        "systemStatus",
                        "üéâ ¬°Sistema test con callAgentRPC() listo!",
                        "success"
                    );
                } catch (error) {
                    logResult(
                        "systemStatus",
                        `‚ùå Error: ${error.message}`,
                        "error"
                    );
                    console.error("System initialization error:", error);
                }
            }

            function setupEventListeners() {
                if (!voiceAgent) return;

                voiceAgent.on("roomConnected", () => {
                    logResult("systemStatus", "üîó Room conectado", "success");
                    updateButtons(true);
                });

                voiceAgent.on("roomDisconnected", () => {
                    logResult(
                        "systemStatus",
                        "‚ùå Room desconectado",
                        "warning"
                    );
                    updateButtons(false);
                });

                voiceAgent.on("agentConnected", (participant) => {
                    logResult(
                        "systemStatus",
                        `ü§ñ Agente: ${participant.identity}`,
                        "success"
                    );
                });
            }

            async function connectToAgent() {
                if (!isSystemInitialized) {
                    logResult(
                        "systemStatus",
                        "‚ùå Inicializa el sistema primero",
                        "error"
                    );
                    return;
                }

                try {
                    logResult("systemStatus", "üîó Conectando...", "info");
                    await voiceAgent.initialize();
                    logResult(
                        "systemStatus",
                        "‚úÖ ¬°Conectado exitosamente!",
                        "success"
                    );
                } catch (error) {
                    logResult(
                        "systemStatus",
                        `‚ùå Error: ${error.message}`,
                        "error"
                    );
                }
            }

            async function disconnectAgent() {
                if (voiceAgent) {
                    try {
                        await voiceAgent.disconnect();
                        logResult("systemStatus", "üëã Desconectado", "info");
                        updateButtons(false);
                    } catch (error) {
                        logResult(
                            "systemStatus",
                            `‚ùå Error: ${error.message}`,
                            "error"
                        );
                    }
                }
            }

            // ‚úÖ FIXED: Tests RPC usando callAgentRPC() en lugar de callRPCMethod()
            async function testHeartbeat() {
                if (!voiceAgent?.getState()?.connected) {
                    logResult("outgoingResults", "‚ùå No conectado", "error");
                    return;
                }

                try {
                    logResult(
                        "outgoingResults",
                        "üíì Testing heartbeat con callAgentRPC()...",
                        "info"
                    );
                    // ‚úÖ FIXED: callRPCMethod ‚Üí callAgentRPC
                    const result = await voiceAgent.callAgentRPC("heartbeat", {
                        test: true,
                        timestamp: Date.now(),
                    });
                    logResult("outgoingResults", "‚úÖ Heartbeat OK:", "success");
                    logResult(
                        "outgoingResults",
                        JSON.stringify(result, null, 2),
                        "success"
                    );
                } catch (error) {
                    logResult(
                        "outgoingResults",
                        `‚ùå Error: ${error.message}`,
                        "error"
                    );
                }
            }

            async function testAgentCommand() {
                if (!voiceAgent?.getState()?.connected) {
                    logResult("outgoingResults", "‚ùå No conectado", "error");
                    return;
                }

                try {
                    logResult(
                        "outgoingResults",
                        "ü§ñ Testing command con callAgentRPC()...",
                        "info"
                    );
                    // ‚úÖ FIXED: callRPCMethod ‚Üí callAgentRPC
                    const result = await voiceAgent.callAgentRPC(
                        "agent_command",
                        {
                            command: "test_command",
                            params: { test_mode: true },
                        }
                    );
                    logResult("outgoingResults", "‚úÖ Command OK:", "success");
                    logResult(
                        "outgoingResults",
                        JSON.stringify(result, null, 2),
                        "success"
                    );
                } catch (error) {
                    logResult(
                        "outgoingResults",
                        `‚ùå Error: ${error.message}`,
                        "error"
                    );
                }
            }

            async function testLLMFunction() {
                if (!voiceAgent?.getState()?.connected) {
                    logResult("outgoingResults", "‚ùå No conectado", "error");
                    return;
                }

                try {
                    logResult(
                        "outgoingResults",
                        "üß† Testing LLM con callAgentRPC()...",
                        "info"
                    );
                    // ‚úÖ FIXED: callRPCMethod ‚Üí callAgentRPC
                    const result = await voiceAgent.callAgentRPC(
                        "llm_function_call",
                        {
                            function_name: "test_function",
                            arguments: { test: true },
                        }
                    );
                    logResult("outgoingResults", "‚úÖ LLM OK:", "success");
                    logResult(
                        "outgoingResults",
                        JSON.stringify(result, null, 2),
                        "success"
                    );
                } catch (error) {
                    logResult(
                        "outgoingResults",
                        `‚ùå Error: ${error.message}`,
                        "error"
                    );
                }
            }

            async function testCustomRPC() {
                if (!voiceAgent?.getState()?.connected) {
                    logResult("outgoingResults", "‚ùå No conectado", "error");
                    return;
                }

                try {
                    logResult(
                        "outgoingResults",
                        "‚ö° Testing custom con callAgentRPC()...",
                        "info"
                    );
                    // ‚úÖ FIXED: callRPCMethod ‚Üí callAgentRPC
                    const result = await voiceAgent.callAgentRPC(
                        "custom_method",
                        {
                            message: "Test from callAgentRPC - FIXED!",
                            timestamp: Date.now(),
                        }
                    );
                    logResult("outgoingResults", "‚úÖ Custom OK:", "success");
                    logResult(
                        "outgoingResults",
                        JSON.stringify(result, null, 2),
                        "success"
                    );
                } catch (error) {
                    logResult(
                        "outgoingResults",
                        `‚ùå Error: ${error.message}`,
                        "error"
                    );
                }
            }

            // Debug functions (sin cambios)
            function showRegisteredMethods() {
                if (!voiceAgent) {
                    logResult("incomingResults", "‚ùå No inicializado", "error");
                    return;
                }

                try {
                    const methods = window.CONFIG.rpc.methods;
                    const registered = voiceAgent._registeredRpcMethods;

                    logResult("incomingResults", "üìã M√©todos RPC:", "info");
                    methods.forEach((method) => {
                        const isReg = registered
                            ? registered.has(method)
                            : false;
                        logResult(
                            "incomingResults",
                            `   ${method}: ${isReg ? "‚úÖ" : "‚ùå"}`,
                            isReg ? "success" : "warning"
                        );
                    });
                } catch (error) {
                    logResult(
                        "incomingResults",
                        `‚ùå Error: ${error.message}`,
                        "error"
                    );
                }
            }

            function showVoiceAgentState() {
                if (!voiceAgent) {
                    logResult("debugInfo", "‚ùå No inicializado", "error");
                    return;
                }

                try {
                    const state = voiceAgent.getState();
                    logResult("debugInfo", "üé§ VoiceAgent State:", "info");
                    logResult(
                        "debugInfo",
                        JSON.stringify(state, null, 2),
                        "info"
                    );
                } catch (error) {
                    logResult(
                        "debugInfo",
                        `‚ùå Error: ${error.message}`,
                        "error"
                    );
                }
            }

            function showAppState() {
                if (!voiceApp) {
                    logResult("debugInfo", "‚ùå App no inicializada", "error");
                    return;
                }

                try {
                    const state = voiceApp.getState();
                    logResult("debugInfo", "üì± VoiceAgentApp State:", "info");
                    logResult(
                        "debugInfo",
                        JSON.stringify(state, null, 2),
                        "info"
                    );
                } catch (error) {
                    logResult(
                        "debugInfo",
                        `‚ùå Error: ${error.message}`,
                        "error"
                    );
                }
            }

            function showConfigInfo() {
                try {
                    const info = {
                        test: window.CONFIG.test,
                        rpc: window.CONFIG.rpc,
                        debug: window.CONFIG.debug.enabled,
                    };
                    logResult("debugInfo", "‚öôÔ∏è CONFIG:", "info");
                    logResult(
                        "debugInfo",
                        JSON.stringify(info, null, 2),
                        "info"
                    );
                } catch (error) {
                    logResult(
                        "debugInfo",
                        `‚ùå Error: ${error.message}`,
                        "error"
                    );
                }
            }

            function testSystemMethods() {
                logResult("debugInfo", "üîç Testing system methods...", "info");

                try {
                    if (voiceApp?._components?.ui?.elements?.audioBtn) {
                        const btn = voiceApp._components.ui.elements.audioBtn;
                        logResult("debugInfo", "‚úÖ audioBtn exists", "success");

                        if (typeof btn.querySelector === "function") {
                            const icon = btn.querySelector("i");
                            logResult(
                                "debugInfo",
                                "‚úÖ querySelector() works",
                                "success"
                            );
                            logResult("debugInfo", `   icon: ${icon}`, "info");
                        } else {
                            logResult(
                                "debugInfo",
                                "‚ùå querySelector missing",
                                "error"
                            );
                        }
                    } else {
                        logResult(
                            "debugInfo",
                            "‚ùå audioBtn not found",
                            "error"
                        );
                    }

                    if (voiceAgent)
                        logResult(
                            "debugInfo",
                            "‚úÖ VoiceAgent available",
                            "success"
                        );
                    if (voiceApp)
                        logResult(
                            "debugInfo",
                            "‚úÖ VoiceAgentApp available",
                            "success"
                        );
                    if (window.CONFIG)
                        logResult(
                            "debugInfo",
                            "‚úÖ CONFIG available",
                            "success"
                        );
                    if (window.Logger)
                        logResult(
                            "debugInfo",
                            "‚úÖ Logger available",
                            "success"
                        );

                    // ‚úÖ NUEVO: Test del m√©todo correcto
                    if (
                        voiceAgent &&
                        typeof voiceAgent.callAgentRPC === "function"
                    ) {
                        logResult(
                            "debugInfo",
                            "‚úÖ callAgentRPC() method available",
                            "success"
                        );
                    } else {
                        logResult(
                            "debugInfo",
                            "‚ùå callAgentRPC() method missing",
                            "error"
                        );
                    }
                } catch (error) {
                    logResult(
                        "debugInfo",
                        `‚ùå Test error: ${error.message}`,
                        "error"
                    );
                }
            }

            function simulateIncoming() {
                logResult(
                    "incomingResults",
                    "üé≠ Para test calls entrantes:",
                    "info"
                );
                logResult("incomingResults", "En agente Python:", "info");
                logResult(
                    "incomingResults",
                    'await session.rpc_call("heartbeat", {"test": True})',
                    "info"
                );
                logResult(
                    "incomingResults",
                    'await session.rpc_call("update_ui_state", {"state": "thinking"})',
                    "info"
                );
            }

            // Initialize
            document.addEventListener("DOMContentLoaded", () => {
                logResult(
                    "systemStatus",
                    "üß™ RPC Test - FIXED con callAgentRPC()",
                    "info"
                );
                logResult(
                    "systemStatus",
                    "   ‚úÖ callRPCMethod() ‚Üí callAgentRPC()",
                    "success"
                );
                logResult(
                    "systemStatus",
                    "   1. Setup Test Mode (CONFIG + mocks)",
                    "info"
                );
                logResult(
                    "systemStatus",
                    "   2. Initialize Test System (load + patch)",
                    "info"
                );
                logResult(
                    "systemStatus",
                    "   3. Connect to Agent (test RPC)",
                    "info"
                );
                updateButtons(false);
            });
        </script>
    </body>
</html>
